---
title: "Data handling for Widefield PDGFR-β, NeuN and GFAP-stained brain sections (whole brain) from KLF4-KO mice"
subtitle: "Data analysis notebook"
author: 
  - name: "Daniel Manrique-Castano"
    orcid: 0000-0002-1912-1764
    degrees:
      - PhD
    affiliation: 
      - name: Univerisity Laval 
        department: Psychiatry and Neuroscience
        group: Laboratory of neurovascular interactions 
note: "GitHub: https://daniel-manrique.github.io/"

keywords: 
  - KLF4
  - Brain injury
  - MCAO

license: "CC BY"

format:
   pdf: 
    toc: true
    number-sections: true
    colorlinks: true
   html:
    code-fold: true
    embed-resources: true
    toc: true
    toc-depth: 2
    toc-location: left
    theme: spacelab

knitr:
  opts_chunk: 
    warning: false
    message: false

csl: science.csl
bibliography: references.bib
---

# Preview

In this notebook, we handle .tsv files to obtain summary tables for the number of cells in different brain regions. 

**Parent dataset:** PDGFR-β, NeuN, and GFAP-stained ischemic brains imaged at 5x (with stitching). Samples belong to KLK4-KO mice and corresponding controls 25 days post-ischemia (DPI).

**Working dataset**: .tsv files exported with [QuPath](https://qupath.github.io/) [@bankhead2017]. We performed unbiased detection and quantification of PDGFR-β, NeuN and GFAP-positive cells in whole **whole brain sections**. QuPath generates `_annotations.tsv` files summarizing the information by image. These files are located in the `Data_Raw/Widefield_5x_Whole_EarlyKO_Pdgfrb-NeuN-Gfap/QuPath_Whole_5x` folder within the working directory.

# Install and load required packages

Install and load all required packages. Please uncomment (delete #) the line code if installation is required. Load the installed libraries each time you start a new R session. 

```{r}
#| label: Install_Packages
#| include: true
#| warning: false
#| message: false

#library(devtools)
#install.packages(c("dpylr", "tidyr", "readr", "data.table"))

library(data.table)
library(dplyr)
library(readr)
library(tidyr)
```

# Processing of image **annotations**

The following chunk handles the `_annotations.tsv` files of each image to obtain a single .csv file. We perform different procedure for NeuN given that this marker has some additional columns derived from QuPath Classifiers.

## For NeuN

```{r}
#| label: NeuN_whole_5x_Annotations
#| include: true
#| warning: false
#| message: false
#| results: false

append_annotations <- function(base_path, brain_name, results_path) {
  
  NeuN_csv_path <- paste0(results_path, "/Widefield_5x_Whole_EarlyKO_NeuN.csv")
  Annotations_Path <- paste0(base_path, "/", brain_name, "/NeuN/")
  process_annotation(results_path = NeuN_csv_path, Annotations_Path)
}

process_annotation <- function(results_path, path) {
  
  Annotations <- list.files(path = path, pattern = "annotations.tsv", full.names = TRUE) %>% 
    lapply(read_tsv) %>%                              
    bind_rows
  
  Annotations <- as.data.frame(Annotations)
  names(Annotations) <- NULL
  
  write.table(Annotations, results_path, append = TRUE, sep=",")
}


basePath <- "Data_Raw/Widefield_5x_Whole_EarlyKO_Pdgfrb-NeuN-Gfap/QuPath_Whole_5x"
resultsPath <- "Data_Raw/Widefield_5x_Whole_EarlyKO_Pdgfrb-NeuN-Gfap/"

NeuN_csv_path <- paste0(resultsPath, "/Widefield_5x_Whole_EarlyKO_NeuN.csv")

Annotations_Header <- c("Image",	
                        "Name",	
                        "Class",	
                        "Parent",	
                        "ROI",	
                        "Centroid X ?m",	
                        "Centroid Y ?m",	
                        "ID",	
                        "Parent ID",	
                        "Side",	
                        "Num Detections",	
                        "Num Necrosis", 
                        "Num Positive", 
                        "Positive %", 
                        "Num Positive per mm^2", 
                        "Area ?m^2",	
                        "Perimeter ?m")

df_header <- data.frame(matrix(ncol = 17, nrow = 0))
names(df_header) <- Annotations_Header

write.csv(df_header, NeuN_csv_path)

brains <- list.dirs(basePath, full.names = FALSE, recursive = FALSE)

for (brain in brains){
  append_annotations(basePath, brain, resultsPath)
}

```
## For PDGFR-β and GFAP

```{r}
#| label: NeuN_whole_5x_Annotations
#| include: true
#| warning: false
#| message: false
#| results: false

append_annotations <- function(base_path, brain_name, results_path) {
  
  Pdgfrb_csv_path <- paste0(results_path, "/Widefield_5x_Whole_EarlyKO_Pdgfrb.csv")
  Annotations_Path <- paste0(base_path, "/", brain_name, "/Pdgfrb/")
  process_annotation(results_path = Pdgfr_csv_path, Annotations_Path)
  
  Gfap_csv_path <- paste0(results_path, "/Widefield_5x_Whole_EarlyKO_Gfap.csv")
  Annotations_Path <- paste0(base_path, "/", brain_name, "/Gfap/")
  process_annotation(results_path = Gfap_csv_path, Annotations_Path)
  
}

process_annotation <- function(results_path, path) {
  
  Annotations <- list.files(path = path, pattern = "annotations.tsv", full.names = TRUE) %>% 
    lapply(read_tsv) %>%                              
    bind_rows
  
  Annotations <- as.data.frame(Annotations)
  names(Annotations) <- NULL
  
  write.table(Annotations, results_path, append = TRUE, sep=",")
}


basePath <- "Data_Raw/Widefield_5x_Whole_EarlyKO_Pdgfrb-NeuN-Gfap/QuPath_Whole_5x"
resultsPath <- "Data_Raw/Widefield_5x_Whole_EarlyKO_Pdgfrb-NeuN-Gfap/"

Pdgfrb_csv_path <- paste0(resultsPath, "/Widefield_5x_Whole_EarlyKO_Pdgfrb.csv")
Gfap_csv_path <- paste0(resultsPath, "/Widefield_5x_Whole_EarlyKO_Gfap.csv")

Annotations_Header <- c("Image",	"Name",	"Class",	"Parent",	"ROI",	"Centroid X ?m",	"Centroid Y ?m",	"ID",	"Parent ID",	"Side",	"Num Detections",	"Area ?m^2",	"Perimeter ?m")

df_header <- data.frame(matrix(ncol = 13, nrow = 0))
names(df_header) <- Annotations_Header

write.csv(df_header, Pdgfrb_csv_path)
write.csv(df_header, Gfap_csv_path)

brains <- list.dirs(basePath, full.names = FALSE, recursive = FALSE)

for (brain in brains){
  append_annotations(basePath, brain, resultsPath)
}

```

# Load Annotations and generate new columns

Next, we load the generated .csv files and handle them for data cleaning and organization. We carry out the same procedure for PDGFR-β, NeuN and GFAP.

## For NeuN

```{r}
#| label: NeuN_WideTable
#| include: true
#| warning: false
#| message: false

# Load file from QuPath
NeuN_Raw <- read.csv(file = 'Data_Raw/Widefield_5x_Whole_EarlyKO_Pdgfrb-NeuN-Gfap/Widefield_5x_Whole_EarlyKO_NeuN.csv', header = TRUE)

# Subset the relevant columns
NeuN <- subset(NeuN_Raw, select = c(Image, Class, Num.Positive))

# Extract metadata information from image name
NeuN <- cbind(NeuN  , do.call(rbind , strsplit(NeuN$Image , "[_\\.]"))[,3:6])
colnames(NeuN) <- c( colnames(NeuN[1:3]), paste0("Name" , 1:4))
NeuN <- cbind(NeuN[c(-2,-3)] , NeuN[c(2,3)])

# Rename columns
colnames(NeuN) <- c("Image", "MouseId", "Genotype", "Condition", "Section", "Region", "Cells")

NeuN <- subset(NeuN, select = -c(Image))

NeuN <- reshape2::dcast(NeuN, MouseId + Genotype + Condition ~ Section + Region, value.var="Cells")

# Change Genotype names
NeuN$Genotype <- gsub("Ctr25", "Klf4+/+", NeuN$Genotype)
NeuN$Genotype <- gsub("KO25", "Klf4-/-", NeuN$Genotype)


### Calculate per sections
setDT(NeuN)[, S1_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S1_Left")]
setDT(NeuN)[, S1_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S1_Right")]
NeuN$S1_diff <- NeuN$S1_Left_Sum / NeuN$S1_Right_Sum

setDT(NeuN)[, S2_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S2_Left")]
setDT(NeuN)[, S2_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S2_Right")]
NeuN$S2_diff <- NeuN$S2_Left_Sum / NeuN$S2_Right_Sum

setDT(NeuN)[, S3_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S3_Left")]
setDT(NeuN)[, S3_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S3_Right")]
NeuN$S3_diff <- NeuN$S3_Left_Sum / NeuN$S3_Right_Sum

setDT(NeuN)[, S4_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S4_Left")]
setDT(NeuN)[, S4_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S4_Right")]
NeuN$S4_diff <- NeuN$S4_Left_Sum / NeuN$S4_Right_Sum

setDT(NeuN)[, S5_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S5_Left")]
setDT(NeuN)[, S5_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S5_Right")]
NeuN$S5_diff <- NeuN$S5_Left_Sum / NeuN$S5_Right_Sum

setDT(NeuN)[, S6_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S6_Left")]
setDT(NeuN)[, S6_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S6_Right")]
NeuN$S6_diff <- NeuN$S6_Left_Sum / NeuN$S6_Right_Sum

setDT(NeuN)[, S7_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S7_Left")]
setDT(NeuN)[, S7_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S7_Right")]
NeuN$S7_diff <- NeuN$S7_Left_Sum / NeuN$S7_Right_Sum

setDT(NeuN)[, S8_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S8_Left")]
setDT(NeuN)[, S8_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S8_Right")]
NeuN$S8_diff <- NeuN$S8_Left_Sum / NeuN$S8_Right_Sum

setDT(NeuN)[, S9_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S9_Left")]
setDT(NeuN)[, S9_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S9_Right")]
NeuN$S9_diff <- NeuN$S9_Left_Sum / NeuN$S9_Right_Sum

### Calculate per regions

setDT(NeuN)[, Sum_Left_CTX := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Left: CTX")]
setDT(NeuN)[, Sum_Right_CTX := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Right: CTX")]
NeuN$CTX_diff <- NeuN$Sum_Left_CTX / NeuN$Sum_Right_CTX

setDT(NeuN)[, Sum_Left_CNU := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Left: CNU")]
setDT(NeuN)[, Sum_Right_CNU := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Right: CNU")]
NeuN$CNU_diff <- NeuN$Sum_Left_CNU / NeuN$Sum_Right_CNU

setDT(NeuN)[, Sum_Left_Fiber := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Left: fiber tracts")]
setDT(NeuN)[, Sum_Right_Fiber := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Right: fiber tracts")]
NeuN$Fiber_diff <- NeuN$Sum_Left_Fiber / NeuN$Sum_Right_Fiber

setDT(NeuN)[, Sum_Left_IB := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Left: IB")]
setDT(NeuN)[, Sum_Right_IB := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Right: IB")]
NeuN$IB_diff <- NeuN$Sum_Left_IB / NeuN$Sum_Right_IB

setDT(NeuN)[, Sum_Left_MB := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Left: MB")]
setDT(NeuN)[, Sum_Right_MB := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Right: MB")]
NeuN$MB_diff <- NeuN$Sum_Left_MB / NeuN$Sum_Right_MB

```

With the preceding, we obtain the `NeuN` table containing cell counts per region in a wide format. For our purposes, we transform further that table to get total ratios per region. Below, we perform the same procedure for PDGFR-β and GFAP.

```{r}
#| label: NeuN_WideTable
#| include: true
#| warning: false
#| message: false

# Subset and generate summary by hemisphere
NeuN_Regions <- subset(NeuN, select = c(MouseId, Condition, Genotype, CTX_diff, CNU_diff, Fiber_diff, IB_diff, MB_diff))

is.na(NeuN_Regions)<-sapply(NeuN_Regions, is.infinite)
NeuN_Regions[is.na(NeuN_Regions)]<-1

# Add column for hemispheric differences
NeuN_Regions$Hemis_diff <- rowMeans(NeuN_Regions[,c(6:8)], na.rm = TRUE)

# Write file
write.csv(NeuN_Regions,'Data_Processed/Widefield_5x_Whole_EarlyKO_Pdgfrb-NeuN-Gfap/Widefield_5x_Whole_EarlyKO_NeuN.csv')
```

## For Pdgfrb

```{r}
#| label: Pdgfrb_WideTable
#| include: true
#| warning: false
#| message: false

# Load file from QuPath
Pdgfrb_Raw <- read.csv(file = 'Data_Raw/Widefield_5x_Whole_EarlyKO_Pdgfrb-NeuN-Gfap/Widefield_5x_Whole_EarlyKO_Pdgfrb.csv', header = TRUE)

# Subset the relevant columns
Pdgfrb <- subset(Pdgfrb_Raw, select = c(Image, Class, Num.Detections))

# Extract metadata information from image name
Pdgfrb <- cbind(Pdgfrb  , do.call(rbind , strsplit(Pdgfrb$Image , "[_\\.]"))[,3:6])
colnames(Pdgfrb) <- c( colnames(Pdgfrb[1:3]), paste0("Name" , 1:4))
Pdgfrb <- cbind(Pdgfrb[c(-2,-3)] , Pdgfrb[c(2,3)])

# Rename columns
colnames(Pdgfrb) <- c("Image", "MouseId", "Genotype", "Condition", "Section", "Region", "Cells")

Pdgfrb <- subset(Pdgfrb, select = -c(Image))

Pdgfrb <- reshape2::dcast(Pdgfrb, MouseId + Genotype + Condition ~ Section + Region, value.var="Cells")

# Change Genotype names
Pdgfrb$Genotype <- gsub("Ctr25", "Klf4+/+", Pdgfrb$Genotype)
Pdgfrb$Genotype <- gsub("KO25", "Klf4-/-", Pdgfrb$Genotype)


### Calculate per sections
setDT(Pdgfrb)[, S1_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S1_Left")]
setDT(Pdgfrb)[, S1_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S1_Right")]
Pdgfrb$S1_diff <- Pdgfrb$S1_Left_Sum / Pdgfrb$S1_Right_Sum

setDT(Pdgfrb)[, S2_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S2_Left")]
setDT(Pdgfrb)[, S2_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S2_Right")]
Pdgfrb$S2_diff <- Pdgfrb$S2_Left_Sum / Pdgfrb$S2_Right_Sum

setDT(Pdgfrb)[, S3_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S3_Left")]
setDT(Pdgfrb)[, S3_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S3_Right")]
Pdgfrb$S3_diff <- Pdgfrb$S3_Left_Sum / Pdgfrb$S3_Right_Sum

setDT(Pdgfrb)[, S4_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S4_Left")]
setDT(Pdgfrb)[, S4_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S4_Right")]
Pdgfrb$S4_diff <- Pdgfrb$S4_Left_Sum / Pdgfrb$S4_Right_Sum

setDT(Pdgfrb)[, S5_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S5_Left")]
setDT(Pdgfrb)[, S5_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S5_Right")]
Pdgfrb$S5_diff <- Pdgfrb$S5_Left_Sum / Pdgfrb$S5_Right_Sum

setDT(Pdgfrb)[, S6_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S6_Left")]
setDT(Pdgfrb)[, S6_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S6_Right")]
Pdgfrb$S6_diff <- Pdgfrb$S6_Left_Sum / Pdgfrb$S6_Right_Sum

setDT(Pdgfrb)[, S7_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S7_Left")]
setDT(Pdgfrb)[, S7_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S7_Right")]
Pdgfrb$S7_diff <- Pdgfrb$S7_Left_Sum / Pdgfrb$S7_Right_Sum

setDT(Pdgfrb)[, S8_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S8_Left")]
setDT(Pdgfrb)[, S8_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S8_Right")]
Pdgfrb$S8_diff <- Pdgfrb$S8_Left_Sum / Pdgfrb$S8_Right_Sum

setDT(Pdgfrb)[, S9_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S9_Left")]
setDT(Pdgfrb)[, S9_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S9_Right")]
Pdgfrb$S9_diff <- Pdgfrb$S9_Left_Sum / Pdgfrb$S9_Right_Sum


### Calculate per regions

setDT(Pdgfrb)[, Sum_Left_CTX := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Left: CTX")]
setDT(Pdgfrb)[, Sum_Right_CTX := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Right: CTX")]
Pdgfrb$CTX_diff <- Pdgfrb$Sum_Left_CTX / Pdgfrb$Sum_Right_CTX

setDT(Pdgfrb)[, Sum_Left_CNU := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Left: CNU")]
setDT(Pdgfrb)[, Sum_Right_CNU := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Right: CNU")]
Pdgfrb$CNU_diff <- Pdgfrb$Sum_Left_CNU / Pdgfrb$Sum_Right_CNU

setDT(Pdgfrb)[, Sum_Left_Fiber := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Left: fiber tracts")]
setDT(Pdgfrb)[, Sum_Right_Fiber := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Right: fiber tracts")]
Pdgfrb$Fiber_diff <- Pdgfrb$Sum_Left_Fiber / Pdgfrb$Sum_Right_Fiber

setDT(Pdgfrb)[, Sum_Left_IB := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Left: IB")]
setDT(Pdgfrb)[, Sum_Right_IB := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Right: IB")]
Pdgfrb$IB_diff <- Pdgfrb$Sum_Left_IB / Pdgfrb$Sum_Right_IB

setDT(Pdgfrb)[, Sum_Left_MB := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Left: MB")]
setDT(Pdgfrb)[, Sum_Right_MB := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Right: MB")]
Pdgfrb$MB_diff <- Pdgfrb$Sum_Left_MB / Pdgfrb$Sum_Right_MB

```

With the preceding, we obtain the `Pdgfrb` table containing cell counts per region in a wide format. For our purposes, we transform further that table to make it tidy (long format). Below, we perform the same procedure for PDGFR-β and GFAP.

```{r}
#| label: Pdgfrb_LongTable
#| include: true
#| warning: false
#| message: false

# Subset and generate summary by hemisphere
Pdgfrb_Regions <- subset(Pdgfrb, select = c(MouseId, Condition, Genotype, CTX_diff, CNU_diff, Fiber_diff, IB_diff, MB_diff))

is.na(Pdgfrb_Regions)<-sapply(Pdgfrb_Regions, is.infinite)
Pdgfrb_Regions[is.na(Pdgfrb_Regions)]<-1

# Add column for hemispheric differences
Pdgfrb_Regions$Hemis_diff <- rowMeans(Pdgfrb_Regions[,c(6:8)], na.rm = TRUE)

# Write file
write.csv(Pdgfrb_Regions,'Data_Processed/Widefield_5x_Whole_EarlyKO_Pdgfrb-NeuN-Gfap/Widefield_5x_Whole_EarlyKO_Pdgfrb.csv')

```

## For Gfap

```{r}
#| label: Gfap_WideTable
#| include: true
#| warning: false
#| message: false

# Load file from QuPath
Gfap_Raw <- read.csv(file = 'Data_Raw/Widefield_5x_Whole_EarlyKO_Pdgfrb-NeuN-Gfap/Widefield_5x_Whole_EarlyKO_Gfap.csv', header = TRUE)

# Subset the relevant columns
Gfap <- subset(Gfap_Raw, select = c(Image, Class, Num.Detections))

# Extract metadata information from image name
Gfap <- cbind(Gfap  , do.call(rbind , strsplit(Gfap$Image , "[_\\.]"))[,3:6])
colnames(Gfap) <- c( colnames(Gfap[1:3]), paste0("Name" , 1:4))
Gfap <- cbind(Gfap[c(-2,-3)] , Gfap[c(2,3)])

# Rename columns
colnames(Gfap) <- c("Image", "MouseId", "Genotype", "Condition", "Section", "Region", "Cells")

Gfap <- subset(Gfap, select = -c(Image))

Gfap <- reshape2::dcast(Gfap, MouseId + Genotype + Condition ~ Section + Region, value.var="Cells")

# Change Genotype names
Gfap$Genotype <- gsub("Ctr25", "Klf4+/+", Gfap$Genotype)
Gfap$Genotype <- gsub("KO25", "Klf4-/-", Gfap$Genotype)


### Calculate per sections
setDT(Gfap)[, S1_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S1_Left")]
setDT(Gfap)[, S1_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S1_Right")]
Gfap$S1_diff <- Gfap$S1_Left_Sum / Gfap$S1_Right_Sum

setDT(Gfap)[, S2_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S2_Left")]
setDT(Gfap)[, S2_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S2_Right")]
Gfap$S2_diff <- Gfap$S2_Left_Sum / Gfap$S2_Right_Sum

setDT(Gfap)[, S3_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S3_Left")]
setDT(Gfap)[, S3_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S3_Right")]
Gfap$S3_diff <- Gfap$S3_Left_Sum / Gfap$S3_Right_Sum

setDT(Gfap)[, S4_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S4_Left")]
setDT(Gfap)[, S4_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S4_Right")]
Gfap$S4_diff <- Gfap$S4_Left_Sum / Gfap$S4_Right_Sum

setDT(Gfap)[, S5_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S5_Left")]
setDT(Gfap)[, S5_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S5_Right")]
Gfap$S5_diff <- Gfap$S5_Left_Sum / Gfap$S5_Right_Sum

setDT(Gfap)[, S6_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S6_Left")]
setDT(Gfap)[, S6_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S6_Right")]
Gfap$S6_diff <- Gfap$S6_Left_Sum / Gfap$S6_Right_Sum

setDT(Gfap)[, S7_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S7_Left")]
setDT(Gfap)[, S7_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S7_Right")]
Gfap$S7_diff <- Gfap$S7_Left_Sum / Gfap$S7_Right_Sum

setDT(Gfap)[, S8_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S8_Left")]
setDT(Gfap)[, S8_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S8_Right")]
Gfap$S8_diff <- Gfap$S8_Left_Sum / Gfap$S8_Right_Sum

setDT(Gfap)[, S9_Left_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S9_Left")]
setDT(Gfap)[, S9_Right_Sum := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("S9_Right")]
Gfap$S9_diff <- Gfap$S9_Left_Sum / Gfap$S9_Right_Sum


### Calculate per regions

setDT(Gfap)[, Sum_Left_CTX := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Left: CTX")]
setDT(Gfap)[, Sum_Right_CTX := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Right: CTX")]
Gfap$CTX_diff <- Gfap$Sum_Left_CTX / Gfap$Sum_Right_CTX

setDT(Gfap)[, Sum_Left_CNU := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Left: CNU")]
setDT(Gfap)[, Sum_Right_CNU := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Right: CNU")]
Gfap$CNU_diff <- Gfap$Sum_Left_CNU / Gfap$Sum_Right_CNU

setDT(Gfap)[, Sum_Left_Fiber := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Left: fiber tracts")]
setDT(Gfap)[, Sum_Right_Fiber := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Right: fiber tracts")]
Gfap$Fiber_diff <- Gfap$Sum_Left_Fiber / Gfap$Sum_Right_Fiber

setDT(Gfap)[, Sum_Left_IB := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Left: IB")]
setDT(Gfap)[, Sum_Right_IB := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Right: IB")]
Gfap$IB_diff <- Gfap$Sum_Left_IB / Gfap$Sum_Right_IB

setDT(Gfap)[, Sum_Left_MB := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Left: MB")]
setDT(Gfap)[, Sum_Right_MB := rowSums(.SD, na.rm = TRUE), .SDcols = patterns("Right: MB")]
Gfap$MB_diff <- Gfap$Sum_Left_MB / Gfap$Sum_Right_MB

```

With the preceding, we obtain the `Gfap` table containing cell counts per region in a wide format. For our purposes, we transform further that table to make it tidy (long format). Below, we perform the same procedure for PDGFR-β and GFAP.

```{r}
#| label: Gfap_LongTable
#| include: true
#| warning: false
#| message: false

# Subset and generate summary by hemisphere
Gfap_Regions <- subset(Gfap, select = c(MouseId, Condition, Genotype, CTX_diff, CNU_diff, Fiber_diff, IB_diff, MB_diff))

is.na(Gfap_Regions)<-sapply(Gfap_Regions, is.infinite)
Gfap_Regions[is.na(Gfap_Regions)]<-1

# Add column for hemispheric differences
Gfap_Regions$Hemis_diff <- rowMeans(Gfap_Regions[,c(6:8)], na.rm = TRUE)

# Write file
write.csv(Gfap_Regions,'Data_Processed/Widefield_5x_Whole_EarlyKO_Pdgfrb-NeuN-Gfap/Widefield_5x_Whole_EarlyKO_Gfap.csv')
```

# References

::: {#refs}
:::

```{r}
sessionInfo()
```